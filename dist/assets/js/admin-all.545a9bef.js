/*
@licstart  The following is the entire license notice for the
JavaScript code in this page.

Copyright (C) 2010  Goteo Foundation

The JavaScript code in this page is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this page.
*/
function adminProntoLoad(t,e){return e=e||"#admin-content",prontoLoad(t,e)}goteo.typeahead_engines=goteo.typeahead_engines||{},$(function(){$("#main").off("click","a.pronto"),$("#main").on("click","a.pronto",function(t){var e=$(this).attr("href");0!==e.indexOf("#")&&($(this).attr("target")&&0!==e.indexOf("/admin/")||(t.preventDefault(),adminProntoLoad(e,"#admin-content")))}),$("#main").on("submit","form.pronto",function(t){t.preventDefault();var e=$(this).attr("action"),a=$(this).attr("method").toLowerCase(),n=decodeURIComponent($(this).serialize()).replace(/\+/g," ");console.log("submit",e,n,a,location,t),"get"===a&&(location.hash&&(n+=location.hash),adminProntoLoad(e+"?"+n,"#admin-content"))}),$("#main").on("click","table.model-user tr:not(.extra) a",function(t){var e=$(this).attr("href");if(0!==e.indexOf("#")&&0!==e.indexOf("mailto:")&&!$(this).attr("target")){t.preventDefault();$(this).closest("table");var a=$(this).closest("tr"),n=a.attr("id"),o=a.contents("td").length;if($("#manage-"+n).length)return a.removeClass("active"),void $("#manage-"+n).slideUp(function(){$(this).remove()});$('<tr class="extra active"><td id="manage-'+n+'" colspan="'+o+'"></td></tr>').insertAfter(a.addClass("active"));var s=-1===e.indexOf("?")?"?":"&";-1===location.search.indexOf(s+"ajax")&&(e+=s+"ajax",s="&"),location.search&&(e+=s+location.search.substr(1)),adminProntoLoad(e,"#manage-"+n)}}),$.fn.editable.defaults.ajaxOptions={type:"put"},$.fn.editable.defaults.error=function(t,e){return t.responseJSON&&t.responseJSON.error?t.responseJSON.error:t.responseText},$.fn.editableform.buttons='<button type="submit" class="btn btn-cyan btn-sm editable-submit"><i class="fa fa-check"></i></button><button type="button" class="btn btn-default btn-sm editable-cancel"><i class="fa fa-remove"></i></button>',$("#main").on("click",".editable",function(t){var e=$(this).data("target")||this;t.stopPropagation(),t.preventDefault(),$(e).editable("show"),$(e).on("shown",function(t,e){e.input.$input.attr("autocomplete","off")})});var r=function(){$(".collapsable").collapse(),$(".admin-typeahead .typeahead").typeahead("destroy"),$(".admin-typeahead").each(function(){var t=$(this),e=t.data("sources").split(","),a=[{minLength:0,hint:!0,highlight:!0,classNames:{hint:""}}];e.forEach(function(t){goteo.typeahead_engines[t]&&a.push(goteo.typeahead_engines[t]({remote_statuses:"1,2,3,4,5,6",defaults:!0}))}),$.fn.typeahead.apply(t.find(".typeahead"),a).on("typeahead:active",function(t){$(t.target).select()}).on("typeahead:asyncrequest",function(t){$(t.target).addClass("loading")}).on("typeahead:asynccancel typeahead:asyncreceive",function(t){$(t.target).removeClass("loading")})})};r(),$(window).on("pronto.render",function(t){r()}),$("#main").on("change",'.admin-typeahead input[type="checkbox"]',function(t){this.name;var e=$(this).closest(".admin-typeahead"),a=[];e.find('input[type="checkbox"]:checked').each(function(){a.push(this.name)}),e.data("sources",a.join(",")),r()}),$("#admin-modal").on("show.bs.modal",function(t){var e=$(t.relatedTarget),a=e.data("url"),n=e.data("title"),o=$(this),s=o.find(".modal-title"),i=o.find(".modal-body");if(n?s.text(n).show():s.hide(),a){i.html("").addClass("loading");$.ajax({url:a,dataType:"json",success:function(t,e,a){response="string"==typeof t?$.parseJSON(t):t;var n=response.content||response;i.html(n),i.removeClass("loading"),r()},error:function(t,e,a){var n=a;n=response.responseJSON&&response.responseJSON.error?response.responseJSON.error:response.responseText,console.log("error",a,n),i.html(n)}})}})}),$(function(){var c=function(t,e,a){if(!e||void 0===e.items&&!Object.keys(e).length||void 0!==e.items&&!e.items.length)t.html('<small class="text-danger">No data</small>');else if(t.hasClass("discrete-values")){var n=d3.goteo.discretevaluesChart(a);d3.select(t[0]).datum(e).call(n)}else if(t.hasClass("percent-pie")){var o=e.map(function(t){return{label:t.label,value:t.counter}}),s=d3.goteo.pieChart();d3.select(t[0]).datum(o).call(s)}else if(t.hasClass("time-metrics")){var i=e.items.map(function(t){return t.date=new Date(t.date),t});a.min_date=new Date(e.min_date),a.max_date=new Date(e.max_date);var r=d3.goteo.timemetricsChart(a);d3.select(t[0]).datum(i).call(r)}else t.html('<small class="text-danger">Chart not found</small>')},e=function(){var s={},i=!0,r=function(){i=!1;var e=$(this),a=e.data("source");s[a]||(s[a]={settings:e.data(),data:[]});var n=parseInt(s[a].settings.interval,10)||0,o=parseInt(s[a].settings["interval-delay"],10)||0;$.getJSON(a).done(function(t){s[a].data=t,c(e,t,e.data()),n&&(console.log("timeout at ",n,"delay at",o),setTimeout(function(){$('[data-source="'+a+'"]').length&&r.call(e)},1e3*((i?o:0)+n)))}).fail(function(t){console.log("Error fetching ",a,"ERROR:",t),e.html('<small class="text-danger">'+(t.responseJSON&&t.responseJSON.error||t.responseText||t)+"</small>")}).always(function(){e.removeClass("loading")})};$(".d3-chart").each(r),$(".d3-chart-updater").off("click"),$(".d3-chart-updater").on("click",function(t){t.preventDefault();var e=$(this).data("target"),a=$(e).data("source");s[a].settings=$.extend(s[a].settings,$(this).data()),c($(e),s[a].data,s[a].settings)}),$('input[type="checkbox"].d3-chart-updater').off("change"),$('input[type="checkbox"].d3-chart-updater').on("change",function(t){var e=$(this).data(),a=$(this).data("target"),n=$(a).data("source");$(this).prop("checked")?($(this).data("settings-backup",s[n].settings),s[n].settings=$.extend(s[n].settings,e)):$(this).data("settings-backup")&&(s[n].settings=$(this).data("settings-backup")),r.call($(a))}),$(".d3-chart.auto-enlarge").off("click"),$(".d3-chart.auto-enlarge").on("click",function(t){t.preventDefault(),$(this).closest(".chart-wrapper").toggleClass("d3-chart-wide")})};e(),$(window).on("pronto.render",function(t){e()}),$(window).on("autocharts.init",function(t){e()})});